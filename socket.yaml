asyncapi: 2.6.0
info:
  title: Kitchen & Order Socket Service
  version: 1.0.1
  description: |
    Tài liệu mô tả giao thức Socket.IO cho hệ thống quản lý nhà hàng (CDTN).
    
    ### Hướng dẫn xác thực (Auth)
    - **Handshake Auth**: Gửi JWT Access Token qua `auth: { Authorization: "Bearer <token>" }` hoặc Headers.
    - **Permissions**: Server sẽ tự động decode token để check quyền (Admin/Guest).

    ### Giải thích thuật ngữ
    - **publish**: Client (FE) gửi sự kiện lên Server (`socket.emit`).
    - **subscribe**: Client (FE) lắng nghe sự kiện từ Server (`socket.on`).
    - **ack**: Dữ liệu trả về ngay lập tức trong callback function của `socket.emit`.

servers:
  dev:
    url: http://localhost:3000
    protocol: socket.io
    description: Development Server Localhost
    security:
      - bearerAuth: []

tags:
  - name: Admin Actions
    description: Hành động do Admin/Bếp thực hiện (Gửi lên Server)
  - name: Guest Actions
    description: Hành động do Khách hàng thực hiện (Gửi lên Server)
  - name: Server Notifications
    description: Sự kiện Server bắn về (FE cần lắng nghe để update UI)

channels:
  # ==========================================
  # 1. KHU VỰC ADMIN (Gửi lên)
  # ==========================================
  join_kitchen_room:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin tham gia phòng bếp
      description: |
        Admin join vào `admin_room` để nhận thông báo đơn mới/update món.
        **Quyền yêu cầu:** `socket_join_kitchen`
      message:
        payload: 
          type: object
          nullable: true
          description: Không yêu cầu payload
    subscribe:
      tags:
        - name: Server Notifications
      summary: Phản hồi Join thành công
      message:
        $ref: '#/components/messages/JoinSuccess'

  update_order_status:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin cập nhật trạng thái món ăn
      description: |
        Admin chuyển trạng thái món (Pending -> Cooking -> Served -> Reject).
        Server sẽ tính toán và bắn thông báo `update_order_item` cho các bên liên quan.
      message:
        name: UpdateStatusPayload
        payload:
          $ref: '#/components/schemas/UpdateStatusInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  create_order:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin tạo đơn hộ khách
      description: Admin tạo order mới cho một bàn cụ thể.
      message:
        name: CreateOrderAdminPayload
        payload:
          $ref: '#/components/schemas/CreateOrderInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  # ==========================================
  # 2. KHU VỰC GUEST (Gửi lên)
  # ==========================================
  join_table:
    publish:
      tags:
        - name: Guest Actions
      summary: Khách join vào bàn ăn
      description: |
        Khách (hoặc thiết bị tại bàn) join vào room `table_{tableId}`.
        **Quyền yêu cầu:** `socket_join_own_table`
      message:
        payload:
          type: object
          properties:
            tableId:
              type: string
              example: "6578a9b1c2d3e4f5a6b7c8d9"

  create_order:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Khách tự gọi món
      description: Khách gửi danh sách món ăn muốn gọi lên server.
      message:
        name: CreateOrderGuestPayload
        payload:
          $ref: '#/components/schemas/CreateOrderInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  cancel_order:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Khách hủy món ăn
      description: |
        Khách gửi yêu cầu hủy một món đang ở trạng thái Pending.
        Server sẽ kiểm tra logic (hoàn kho, trừ tiền) và trả về kết quả.
      message:
        name: CancelOrderPayload
        payload:
          type: object
          required: [orderId, itemId, status]
          properties:
            orderId:
              type: string
              description: ID của đơn hàng tổng
              example: "6578a9b1c2d3e4f5a6b7c8d9"
            itemId:
              type: string
              description: ID của món ăn trong mảng items
              example: "6578a9b1c2d3e4f5a6b7c999"
            status:
              type: string
              description: Trạng thái muốn chuyển sang (thường là Reject)
              enum: [Reject]
              example: "Reject"
      bindings:
        socketio:
          ack:
            type: object
            properties:
              success:
                type: boolean
                example: true
              message:
                type: string
                example: "Hủy món thành công"
              data:
                type: object
                description: Payload trả về chứa tổng tiền mới và thông báo
                properties:
                  newTotalAmount:
                    type: number
                    description: Tổng tiền mới của đơn hàng sau khi hủy
                    example: 150000
                  message:
                    type: string
                    example: "Khách hàng Nguyen Van A tại bàn 5 đã HỦY món: Cánh gà"

  # ==========================================
  # 3. SERVER NOTIFICATIONS (Lắng nghe về)
  # ==========================================
  
  # Sự kiện: update_order_item
  # Được bắn ra khi trạng thái món thay đổi (Service: updateItemStatus hoặc cancelItemByGuest)
  update_order_item:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Thông báo cập nhật trạng thái/hủy món
      description: >
        Gửi tới `admin_room` và `table_{id}`. 
        Dùng để hiển thị Toast thông báo và cập nhật lại số tiền tổng trên UI.
        Lưu ý: Không trả về chi tiết món, chỉ trả về tiền và message.
      message:
        name: UpdateItemNotification
        payload:
          type: object
          properties:
            newTotalAmount:
              type: number
              description: Tổng tiền mới của đơn hàng sau khi thay đổi
              example: 450000
            message:
              type: string
              description: Nội dung thông báo hiển thị lên màn hình
              example: "Món Cánh gà (SL: 2) của Khách A đã chuyển sang: Đã phục vụ"

  # Sự kiện: new_order:admin
  # Được bắn ra khi có đơn mới (Service: createOrder/createOrderForTable)
  new_order:admin:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Thông báo có đơn hàng MỚI (Cho Admin)
      description: Gửi tới `admin_room` khi có bàn vừa đặt món xong.
      message:
        name: NewOrderAdminNotification
        payload:
          type: object
          properties:
            type:
              type: string
              example: "NEW_ORDER_CREATED:ADMIN"
            message:
              type: string
              example: "Bàn 5 vừa đặt món"
            data:
              $ref: '#/components/schemas/OrderObject'

  # Sự kiện: new_order:guest
  # Được bắn ra khi có đơn mới
  new_order:guest:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Thông báo có đơn hàng MỚI (Cho Khách)
      description: Gửi tới `table_{id}` để các thành viên trong bàn cập nhật danh sách món vừa gọi.
      message:
        name: NewOrderGuestNotification
        payload:
          type: object
          properties:
            type:
              type: string
              example: "NEW_ORDER_CREATED:CLIENT"
            message:
              type: string
              example: "Khách hàng vừa gọi món mới"
            data:
              $ref: '#/components/schemas/OrderObject'

  # Sự kiện lỗi chung
  error_msg:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Thông báo lỗi quyền hạn/hệ thống
      message:
        payload:
          type: string
          example: "Bạn không có quyền truy cập thông báo bếp!"

# ==========================================
# DEFINITIONS (Các định nghĩa dùng chung)
# ==========================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Cấu trúc trả về của Callback (Ack)
    StandardAck:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Thao tác thành công"
    
    # Input cập nhật trạng thái
    UpdateStatusInput:
      type: object
      required: [orderId, itemId, status]
      properties:
        orderId:
          type: string
          example: "6578a9b1c2d3e4f5a6b7c8d9"
        itemId:
          type: string
          example: "6578a9b1c2d3e4f5a6b7c999"
        status:
          type: string
          enum: [Pending, Cooking, Served, Reject]
          example: "Cooking"

    # Input tạo đơn hàng
    CreateOrderInput:
      type: object
      required: [tableId, guestName, items]
      properties:
        tableId:
          type: string
          example: "6578a9b1c2d3e4f5a6b7c8d9"
        guestName:
          type: string
          example: "Nguyen Van A"
        items:
          type: array
          items:
            type: object
            properties:
              dishId:
                type: string
                example: "6578a9b1c2d3e4f5a6b7c001"
              quantity:
                type: integer
                example: 2
              note:
                type: string
                example: "Không cay"

    # Object Order đầy đủ (Trả về trong data)
    OrderObject:
      type: object
      description: Thông tin đầy đủ của đơn hàng từ Database
      properties:
        _id:
          type: string
        tableNumber:
          type: integer
        status:
          type: string
        totalAmount:
          type: number
        items:
          type: array
          items:
            type: object
            description: Chi tiết từng món trong đơn
            properties:
              dishName:
                type: string
                example: "Cơm rang dưa bò"
              quantity:
                type: integer
              status:
                type: string
                example: "Pending"

  messages:
    JoinSuccess:
      name: join_success
      payload:
        type: object
        properties:
          message:
            type: string
            example: "Bạn đã vào phòng bếp"
          roomId:
            type: string
            example: "admin_room"