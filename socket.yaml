asyncapi: 2.6.0
info:
  title: Kitchen & Order Socket Service (CDTN)
  version: 1.1.0
  description: |
    T√†i li·ªáu m√¥ t·∫£ giao th·ª©c Socket.IO cho h·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng.
    C·∫≠p nh·∫≠t t√≠nh nƒÉng: **Thanh to√°n ti·ªÅn m·∫∑t (Cash Payment)**.
    
    ### üîê H∆∞·ªõng d·∫´n x√°c th·ª±c (Auth)
    - **Handshake**: G·ª≠i Token qua `auth: { Authorization: "Bearer <token>" }` ho·∫∑c Headers.
    - **Permissions**: Server t·ª± ƒë·ªông decode token ƒë·ªÉ check quy·ªÅn (Admin/Guest).

servers:
  dev:
    url: http://localhost:3000
    protocol: socket.io
    description: Development Server
    security:
      - bearerAuth: []

tags:
  - name: Guest Actions
    description: S·ª± ki·ªán t·ª´ ph√≠a Kh√°ch h√†ng g·ª≠i l√™n (Client -> Server)
  - name: Admin Actions
    description: S·ª± ki·ªán t·ª´ ph√≠a Qu·∫£n l√Ω/B·∫øp g·ª≠i l√™n (Client -> Server)
  - name: Server Notifications
    description: S·ª± ki·ªán Server b·∫Øn v·ªÅ c√°c Room (Server -> Client)

channels:
  # ==========================================
  # 1. GUEST CHANNELS (Client -> Server)
  # ==========================================
  
  join_table:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch gia nh·∫≠p b√†n
      description: |
        Kh√°ch qu√©t QR v√† join v√†o room `table_{tableId}`.
        **Quy·ªÅn:** `socket_join_own_table`
      message:
        payload:
          type: object
          properties:
            tableId:
              type: string
              example: "6578a9b1c2d3e4f5a6b7c8d9"

  create_order:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch g·ªçi m√≥n m·ªõi
      description: G·ª≠i danh s√°ch m√≥n ƒÉn l√™n server ƒë·ªÉ t·∫°o ƒë∆°n.
      message:
        payload:
          $ref: '#/components/schemas/CreateOrderInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  cancel_order:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch h·ªßy m√≥n (Pending)
      description: Ch·ªâ h·ªßy ƒë∆∞·ª£c m√≥n ƒëang ·ªü tr·∫°ng th√°i Pending.
      message:
        payload:
          type: object
          required: [orderId, itemId, status]
          properties:
            orderId:
              type: string
            itemId:
              type: string
            status:
              type: string
              enum: [Reject]
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/CancelOrderAck'

  get_orders:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: L·∫•y danh s√°ch m√≥n theo tr·∫°ng th√°i
      description: D√πng cho popup "Theo d√µi ƒë∆°n h√†ng". Tr·∫£ v·ªÅ list m√≥n chia theo 4 nh√≥m tr·∫°ng th√°i.
      message:
        payload:
          type: object
          properties:
            tableId:
              type: string
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/GetOrdersAck'

  pay_by_cash:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch y√™u c·∫ßu thanh to√°n ti·ªÅn m·∫∑t
      description: |
        Kh√°ch nh·∫•n n√∫t "Thanh to√°n ti·ªÅn m·∫∑t". 
        Server s·∫Ω g·ª≠i th√¥ng b√°o `pay_by_cash_notification` ƒë·∫øn Admin Room.
      message:
        payload:
          $ref: '#/components/schemas/PayByCashPayload'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  # ==========================================
  # 2. ADMIN CHANNELS (Client -> Server)
  # ==========================================

  join_kitchen_room:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin gia nh·∫≠p b·∫øp
      description: Join v√†o `admin_room` ƒë·ªÉ nh·∫≠n ƒë∆°n m·ªõi v√† th√¥ng b√°o thanh to√°n.
      message:
        payload: 
          type: object
          nullable: true
    subscribe:
      tags:
        - name: Server Notifications
      summary: Ph·∫£n h·ªìi Join th√†nh c√¥ng
      message:
        payload:
          type: object
          properties:
            message:
              type: string
            roomId:
              type: string

  update_order_status:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: C·∫≠p nh·∫≠t tr·∫°ng th√°i m√≥n
      description: Chuy·ªÉn tr·∫°ng th√°i Pending -> Cooking -> Served -> Reject.
      message:
        payload:
          $ref: '#/components/schemas/UpdateStatusInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  create_order:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin t·∫°o ƒë∆°n h·ªô kh√°ch
      description: Admin d√πng tablet ƒë·ªÉ order gi√πm kh√°ch.
      message:
        payload:
          $ref: '#/components/schemas/CreateOrderInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  confirmed_pay_by_cash:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin x√°c nh·∫≠n ƒë√£ thu ti·ªÅn m·∫∑t
      description: |
        Sau khi thu ti·ªÅn t·∫°i b√†n, Admin nh·∫•n x√°c nh·∫≠n.
        H√†nh ƒë·ªông n√†y set ƒë∆°n h√†ng th√†nh `PAID` v√† gi·∫£i ph√≥ng b√†n.
      message:
        payload:
          $ref: '#/components/schemas/PayByCashPayload'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  # ==========================================
  # 3. SERVER NOTIFICATIONS (Server -> Client)
  # ==========================================

  # --- Nh√≥m th√¥ng b√°o v·ªÅ ƒê∆°n h√†ng ---
  new_order:guest:
    subscribe:
      tags:
        - name: Server Notifications
      summary: C√≥ ƒë∆°n m·ªõi (G·ª≠i cho Kh√°ch)
      description: G·ª≠i t·ªõi `table_{id}` ƒë·ªÉ ƒë·ªìng b·ªô gi·ªØa c√°c thi·∫øt b·ªã c·ªßa kh√°ch.
      message:
        payload:
          $ref: '#/components/schemas/OrderObjectPayload'

  new_order:admin:
    subscribe:
      tags:
        - name: Server Notifications
      summary: C√≥ ƒë∆°n m·ªõi (G·ª≠i cho B·∫øp/Admin)
      description: G·ª≠i t·ªõi `admin_room` ƒë·ªÉ b·∫øp bi·∫øt c√≥ m√≥n m·ªõi.
      message:
        payload:
          $ref: '#/components/schemas/OrderObjectPayload'

  update_order_item:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Toast th√¥ng b√°o tr·∫°ng th√°i m√≥n
      description: G·ª≠i t·ªõi c·∫£ Admin v√† Guest khi 1 m√≥n thay ƒë·ªïi tr·∫°ng th√°i.
      message:
        payload:
          $ref: '#/components/schemas/UpdateItemNotification'

  order_update:admin:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Reload danh s√°ch ƒë∆°n (Admin)
      description: G·ª≠i t·ªõi Admin ƒë·ªÉ c·∫≠p nh·∫≠t l·∫°i UI qu·∫£n l√Ω ƒë∆°n h√†ng.
      message:
        payload:
          type: object
          properties:
            order:
              type: array
              items:
                $ref: '#/components/schemas/OrderObject'

  order:update:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Reload chi ti·∫øt ƒë∆°n (Guest)
      description: G·ª≠i t·ªõi Guest ƒë·ªÉ c·∫≠p nh·∫≠t l·∫°i danh s√°ch m√≥n ƒë√£ g·ªçi.
      message:
        payload:
          $ref: '#/components/schemas/OrderObject'

  # --- Nh√≥m th√¥ng b√°o v·ªÅ Thanh to√°n (Payment) ---
  
  pay_by_cash_notification:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Th√¥ng b√°o kh√°ch mu·ªën tr·∫£ ti·ªÅn m·∫∑t (Admin)
      description: G·ª≠i t·ªõi `admin_room` khi kh√°ch nh·∫•n n√∫t g·ªçi thanh to√°n.
      message:
        payload:
          type: object
          properties:
            message:
              type: string
              example: "B√†n 12 mu·ªën thanh to√°n b·∫±ng ti·ªÅn m·∫∑t."

  payment_success:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Thanh to√°n th√†nh c√¥ng (Guest)
      description: |
        G·ª≠i t·ªõi `table_{id}` sau khi Admin x√°c nh·∫≠n thu ti·ªÅn ho·∫∑c thanh to√°n Online th√†nh c√¥ng.
        Client d√πng ƒë·ªÉ hi·ªán m√†n h√¨nh "C·∫£m ∆°n".
      message:
        payload:
          $ref: '#/components/schemas/PaymentSuccessPayload'

  payment_received:
    subscribe:
      tags:
        - name: Server Notifications
      summary: ƒê√£ nh·∫≠n ti·ªÅn (Admin)
      description: G·ª≠i t·ªõi `admin_room` ƒë·ªÉ ƒë·ªìng b·ªô tr·∫°ng th√°i b√†n (ƒê·ªè -> Xanh).
      message:
        payload:
          $ref: '#/components/schemas/PaymentReceivedPayload'

  # --- L·ªói h·ªá th·ªëng ---
  error_msg:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Th√¥ng b√°o l·ªói chung
      message:
        payload:
          type: string

# ==========================================
# DEFINITIONS
# ==========================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- INPUT SCHEMAS ---
    PayByCashPayload:
      type: object
      required: [orderId]
      properties:
        orderId:
          type: string
          example: "65f2ea21d1d14ce2ee11a972"

    UpdateStatusInput:
      type: object
      required: [orderId, itemId, status]
      properties:
        orderId:
          type: string
        itemId:
          type: string
        status:
          type: string
          enum: [Pending, Cooking, Served, Reject]

    CreateOrderInput:
      type: object
      required: [tableId, guestName, items]
      properties:
        tableId:
          type: string
        guestName:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              dishId: 
                type: string
              quantity: 
                type: integer
              note: 
                type: string

    # --- ACKNOWLEDGEMENT SCHEMAS ---
    StandardAck:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    CancelOrderAck:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            newTotalAmount:
              type: number
            message:
              type: string

    GetOrdersAck:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          $ref: '#/components/schemas/GroupedOrderItems'

    # --- DATA OBJECT SCHEMAS ---
    DishItemObject:
      type: object
      properties:
        _id:
          type: string
        dishId:
          type: string
        dishName:
          type: string
        dishPrice:
          type: number
        dishImage:
          type: string
        quantity:
          type: integer
        note:
          type: string
        orderedBy:
          type: string
        status:
          type: string
          enum: [Pending, Cooking, Served, Reject]
        createdAt:
          type: string
          format: date-time

    OrderObject:
      type: object
      properties:
        _id:
          type: string
        tableNumber:
          type: integer
        status:
          type: string
        totalAmount:
          type: number
        items:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'

    GroupedOrderItems:
      type: object
      properties:
        Pending:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'
        Cooking:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'
        Served:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'
        Reject:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'

    # --- NOTIFICATION PAYLOAD SCHEMAS ---
    OrderObjectPayload:
      type: object
      properties:
        type:
          type: string
        message:
          type: string
        data:
          $ref: '#/components/schemas/OrderObject'

    UpdateItemNotification:
      type: object
      properties:
        orderId:
          type: string
        itemId:
          type: string
        status:
          type: string
        mamageBy:
          type: string
        newTotalAmount:
          type: number
        message:
          type: string

    PaymentItemSummary:
      type: object
      description: Object r√∫t g·ªçn hi·ªÉn th·ªã trong h√≥a ƒë∆°n
      properties:
        dishId:
          type: string
        dishName:
          type: string
        quantity:
          type: integer
        image:
          type: string

    PaymentSuccessPayload:
      type: object
      properties:
        orderId:
          type: string
        amount:
          type: number
        message:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/PaymentItemSummary'

    PaymentReceivedPayload:
      type: object
      properties:
        orderId:
          type: string
        tableNumber:
          type: integer
        amount:
          type: number
        message:
          type: string