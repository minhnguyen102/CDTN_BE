asyncapi: 2.6.0
info:
  title: Kitchen & Order Socket Service (CDTN)
  version: 1.0.2
  description: |
    T√†i li·ªáu m√¥ t·∫£ giao th·ª©c Socket.IO cho h·ªá th·ªëng qu·∫£n l√Ω nh√† h√†ng.
    
    ### üîê H∆∞·ªõng d·∫´n x√°c th·ª±c (Auth)
    - **Handshake**: G·ª≠i Token qua `auth: { Authorization: "Bearer <token>" }` ho·∫∑c Headers.
    - **Permissions**: Server t·ª± ƒë·ªông decode token ƒë·ªÉ check quy·ªÅn (Admin/Guest).

    ### üîÑ C∆° ch·∫ø ho·∫°t ƒë·ªông
    1. **Request-Response (Ack)**: Client `emit` s·ª± ki·ªán v√† nh·∫≠n k·∫øt qu·∫£ ngay l·∫≠p t·ª©c trong `callback` function.
    2. **Realtime Notification**: Client `on` (l·∫Øng nghe) s·ª± ki·ªán th·ª• ƒë·ªông t·ª´ Server ƒë·ªÉ c·∫≠p nh·∫≠t UI.

servers:
  dev:
    url: http://localhost:3000
    protocol: socket.io
    description: Development Server
    security:
      - bearerAuth: []

tags:
  - name: Admin Actions
    description: H√†nh ƒë·ªông do Admin/B·∫øp th·ª±c hi·ªán (G·ª≠i l√™n Server)
  - name: Guest Actions
    description: H√†nh ƒë·ªông do Kh√°ch h√†ng th·ª±c hi·ªán (G·ª≠i l√™n Server)
  - name: Server Notifications
    description: S·ª± ki·ªán Server b·∫Øn v·ªÅ (FE c·∫ßn l·∫Øng nghe ƒë·ªÉ update UI)

channels:
  # ==========================================
  # 1. KHU V·ª∞C ADMIN (Client -> Server)
  # ==========================================
  join_kitchen_room:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin tham gia ph√≤ng b·∫øp
      description: |
        Admin join v√†o `admin_room` ƒë·ªÉ nh·∫≠n th√¥ng b√°o ƒë∆°n m·ªõi.
        **Quy·ªÅn:** `socket_join_kitchen`
      message:
        payload: 
          type: object
          nullable: true
    subscribe:
      tags:
        - name: Server Notifications
      summary: Ph·∫£n h·ªìi Join th√†nh c√¥ng
      message:
        $ref: '#/components/messages/JoinSuccess'

  update_order_status:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin c·∫≠p nh·∫≠t tr·∫°ng th√°i m√≥n
      description: |
        Chuy·ªÉn tr·∫°ng th√°i: Pending -> Cooking -> Served -> Reject.
        Server s·∫Ω b·∫Øn `update_order_item` v√† `order:update` v·ªÅ cho client.
      message:
        payload:
          $ref: '#/components/schemas/UpdateStatusInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  create_order:admin:
    publish:
      tags:
        - name: Admin Actions
      summary: Admin t·∫°o ƒë∆°n h·ªô kh√°ch
      description: T·∫°o ho·∫∑c c·∫≠p nh·∫≠t ƒë∆°n cho m·ªôt b√†n c·ª• th·ªÉ.
      message:
        payload:
          $ref: '#/components/schemas/CreateOrderInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  # ==========================================
  # 2. KHU V·ª∞C GUEST (Client -> Server)
  # ==========================================
  join_table:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch join v√†o b√†n ƒÉn
      description: |
        Join v√†o room `table_{tableId}` ƒë·ªÉ nh·∫≠n th√¥ng b√°o realtime c·ªßa b√†n.
        **Quy·ªÅn:** `socket_join_own_table`
      message:
        payload:
          type: object
          properties:
            tableId:
              type: string
              example: "6578a9b1c2d3e4f5a6b7c8d9"

  create_order:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch g·ªçi m√≥n
      description: G·ª≠i danh s√°ch m√≥n l√™n server.
      message:
        payload:
          $ref: '#/components/schemas/CreateOrderInput'
      bindings:
        socketio:
          ack:
            $ref: '#/components/schemas/StandardAck'

  cancel_order:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: Kh√°ch h·ªßy m√≥n
      description: |
        Kh√°ch h·ªßy m√≥n khi ƒëang ·ªü tr·∫°ng th√°i Pending.
        Server ho√†n kho, tr·ª´ ti·ªÅn v√† tr·∫£ v·ªÅ th√¥ng tin c·∫≠p nh·∫≠t.
      message:
        payload:
          type: object
          required: [orderId, itemId, status]
          properties:
            orderId:
              type: string
              example: "6578a9b1c2d3e4f5a6b7c8d9"
            itemId:
              type: string
              example: "6578a9b1c2d3e4f5a6b7c999"
            status:
              type: string
              enum: [Reject]
              example: "Reject"
      bindings:
        socketio:
          ack:
            type: object
            properties:
              success:
                type: boolean
              message:
                type: string
              data:
                type: object
                description: Data tr·∫£ v·ªÅ trong callback (ch·ª©a ti·ªÅn m·ªõi)
                properties:
                  orderId:
                    type: string
                  itemId:
                    type: string
                  status: 
                    type: string
                  mamageBy:
                    type: string
                  newTotalAmount:
                    type: number
                    description: T·ªïng ti·ªÅn m·ªõi sau khi tr·ª´ ho√†n ti·ªÅn
                  message:
                    type: string
                    description: Th√¥ng b√°o chi ti·∫øt

  # [NEW] S·ª± ki·ªán l·∫•y danh s√°ch m√≥n theo nh√≥m
  get_orders:guest:
    publish:
      tags:
        - name: Guest Actions
      summary: L·∫•y danh s√°ch m√≥n (ƒê√£ ph√¢n nh√≥m)
      description: |
        D√πng khi kh√°ch m·ªü popup "Theo d√µi ƒë∆°n h√†ng".
        Server tr·∫£ v·ªÅ danh s√°ch items ƒë√£ ƒë∆∞·ª£c chia v√†o 4 key: Pending, Cooking, Served, Reject.
      message:
        payload:
          type: object
          properties:
            tableId:
              type: string
              description: C√≥ th·ªÉ g·ª≠i ho·∫∑c kh√¥ng (n·∫øu server l·∫•y t·ª´ token)
      bindings:
        socketio:
          ack:
            type: object
            properties:
              success:
                type: boolean
                example: true
              message:
                type: string
                example: "L·∫•y danh s√°ch ƒë∆°n h√†ng th√†nh c√¥ng"
              data:
                $ref: '#/components/schemas/GroupedOrderItems'

  # ==========================================
  # 3. SERVER NOTIFICATIONS (Server -> Client)
  # ==========================================
  
  # Notification: update_order_item
  # M·ª•c ƒë√≠ch: Hi·ªÉn th·ªã Toast th√¥ng b√°o + C·∫≠p nh·∫≠t ti·ªÅn (Nh·∫π)
  update_order_item:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Th√¥ng b√°o tr·∫°ng th√°i m√≥n thay ƒë·ªïi (Toast)
      description: >
        G·ª≠i t·ªõi `admin_room` v√† `table_{id}`.
        D√πng ƒë·ªÉ hi·ªán Toast: "M√≥n X ƒë√£ chuy·ªÉn sang Y" v√† update s·ªë ti·ªÅn t·ªïng.
        FE d√πng `itemId` v√† `status` trong n√†y ƒë·ªÉ t·ª± c·∫≠p nh·∫≠t UI c·ª•c b·ªô (Optimistic UI).
      message:
        payload:
          type: object
          properties:
            orderId:
              type: string
            itemId:
              type: string
            status:
              type: string
              enum: [Pending, Cooking, Served, Reject]
            mamageBy:
              type: string
              description: T√™n ng∆∞·ªùi th·ª±c hi·ªán (Admin ho·∫∑c Guest)
            newTotalAmount:
              type: number
              description: T·ªïng ti·ªÅn m·ªõi c·ªßa ƒë∆°n h√†ng
            message:
              type: string
              description: N·ªôi dung hi·ªÉn th·ªã Toast

  # [NEW] Notification: order:update
  # M·ª•c ƒë√≠ch: ƒê·ªìng b·ªô d·ªØ li·ªáu (N·∫∑ng)
  # S·ª± ki·ªán n√†y ƒë∆∞·ª£c b·∫Øn k√®m v·ªõi update_order_item trong code service
  order:update:
    subscribe:
      tags:
        - name: Server Notifications
      summary: G·ª≠i v·ªÅ TO√ÄN B·ªò object ƒë∆°n h√†ng m·ªõi
      description: >
        G·ª≠i t·ªõi `table_{id}` sau khi Admin ho·∫∑c Kh√°ch c·∫≠p nh·∫≠t ƒë∆°n.
        Payload ch·ª©a full th√¥ng tin ƒë∆°n h√†ng t·ª´ DB.
        **FE c√≥ th·ªÉ d√πng s·ª± ki·ªán n√†y ƒë·ªÉ set l·∫°i to√†n b·ªô state ƒë∆°n h√†ng cho ch·∫Øc ch·∫Øn.**
      message:
        payload:
          $ref: '#/components/schemas/OrderObject'

  # Notification: New Order (Admin)
  new_order:admin:
    subscribe:
      tags:
        - name: Server Notifications
      summary: C√≥ ƒë∆°n m·ªõi (G·ª≠i cho Admin)
      message:
        payload:
          type: object
          properties:
            type: 
              type: string
              example: "NEW_ORDER_CREATED:ADMIN"
            message:
              type: string
            data:
              $ref: '#/components/schemas/OrderObject'

  # Notification: New Order (Guest)
  new_order:guest:
    subscribe:
      tags:
        - name: Server Notifications
      summary: C√≥ ƒë∆°n m·ªõi (G·ª≠i cho Kh√°ch c√πng b√†n)
      message:
        payload:
          type: object
          properties:
            type: 
              type: string
              example: "NEW_ORDER_CREATED:CLIENT"
            message:
              type: string
            data:
              $ref: '#/components/schemas/OrderObject'

  error_msg:
    subscribe:
      tags:
        - name: Server Notifications
      summary: Th√¥ng b√°o l·ªói chung
      message:
        payload:
          type: string

# ==========================================
# DEFINITIONS
# ==========================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    StandardAck:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    UpdateStatusInput:
      type: object
      required: [orderId, itemId, status]
      properties:
        orderId:
          type: string
        itemId:
          type: string
        status:
          type: string
          enum: [Pending, Cooking, Served, Reject]

    CreateOrderInput:
      type: object
      required: [tableId, guestName, items]
      properties:
        tableId:
          type: string
        guestName:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              dishId: 
                type: string
              quantity: 
                type: integer
              note: 
                type: string

    # Object chi ti·∫øt 1 m√≥n ƒÉn trong ƒë∆°n
    DishItemObject:
      type: object
      properties:
        _id:
          type: string
        dishId:
          type: string
        dishName:
          type: string
        dishPrice:
          type: number
        dishImage:
          type: string
        quantity:
          type: integer
        note:
          type: string
        orderedBy:
          type: string
        status:
          type: string
          enum: [Pending, Cooking, Served, Reject]
        createdAt:
          type: string
          format: date-time

    # Object Order ƒë·∫ßy ƒë·ªß
    OrderObject:
      type: object
      properties:
        _id:
          type: string
        tableNumber:
          type: integer
        status:
          type: string
        totalAmount:
          type: number
        items:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'

    # [NEW] C·∫•u tr√∫c tr·∫£ v·ªÅ c·ªßa get_orders:guest
    GroupedOrderItems:
      type: object
      description: Danh s√°ch items ƒë√£ ƒë∆∞·ª£c ph√¢n lo·∫°i theo tr·∫°ng th√°i
      properties:
        Pending:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'
        Cooking:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'
        Served:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'
        Reject:
          type: array
          items:
            $ref: '#/components/schemas/DishItemObject'

  messages:
    JoinSuccess:
      payload:
        type: object
        properties:
          message:
            type: string
          roomId:
            type: string